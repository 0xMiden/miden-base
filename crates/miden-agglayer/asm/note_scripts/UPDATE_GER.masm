use.miden::agglayer::bridge_in
use.miden::protocol::active_note

# CONSTANTS
# =================================================================================================
const UPDATE_GER_NOTE_NUM_STORAGE_ITEMS = 8
const STORAGE_PTR = 0

# ERRORS
# =================================================================================================
const ERR_UPDATE_GER_UNEXPECTED_NUMBER_OF_STORAGE_ITEMS = "UPDATE_GER script expects exactly 8 note storage items"

#! Agglayer Bridge UPDATE_GER script: updates the GER by calling the bridge_in::update_ger function.
#!
#! This note can only be consumed by the specific agglayer bridge account whose ID is provided
#! in the note attachment (target_account_id).
#!
#! Requires that the account exposes:
#! - agglayer::bridge_in::update_ger procedure.
#!
#! Inputs:  [ARGS, pad(12)]
#! Outputs: [pad(16)]
#! NoteStorage layout (8 felts total):
#! - GER_UPPER [0..3]
#! - GER_LOWER [4..7]
#!
#! Panics if:
#! - account does not expose update_ger procedure.
#! - target account ID does not match the consuming account ID.
#! - number of note storage items is not exactly 8.
begin
    dropw
    # => [pad(16)]

    push.STORAGE_PTR exec.active_note::get_storage
    # => [num_storage_items, dest_ptr, pad(16)]

    push.UPDATE_GER_NOTE_NUM_STORAGE_ITEMS assert_eq.err=ERR_UPDATE_GER_UNEXPECTED_NUMBER_OF_STORAGE_ITEMS drop
    # => [pad(16)]

    # Load GER_UPPER
    mem_loadw_le.4
    # => [[GER_UPPER]]

    padw mem_loadw_le.0
    # => [[GER_LOWER], [GER_UPPER]]

    call.bridge_in::update_ger
    # => []

    dropw drop
    # => [pad(16)]
end