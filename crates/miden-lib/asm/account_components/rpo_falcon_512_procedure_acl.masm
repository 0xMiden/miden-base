use.miden::account
use.miden::tx

# CONSTANTS
# =================================================================================================

# Event to place the falcon signature of a provided message and public key on the advice stack.
const.FALCON_SIG_TO_STACK=131087

# The slot in this component's storage layout where the public key is stored.
const.PUBLIC_KEY_SLOT=0

# The slot where the number of tracked procedures is stored.
const.NUM_TRACKED_PROCS_SLOT=1

# The starting slot for tracked procedure roots (each root takes 1 slot, storing 4 field elements).
const.TRACKED_PROCS_START_SLOT=2

#! Authenticate a transaction using the Falcon signature scheme only if certain procedures were called
#!
#! This authentication procedure checks if any of the tracked procedures were called during the
#! transaction. If none were called, authentication is skipped. If at least one was called,
#! the standard RpoFalcon512 signature verification is performed.
#!
#! Inputs:  [pad(16)]
#! Outputs: [pad(16)]
export.auth__tx_rpo_falcon512_conditional
    # Get the number of tracked procedures
    push.NUM_TRACKED_PROCS_SLOT exec.account::get_item
    # => [num_tracked_procs, pad(16)]

    # Check if any tracked procedure was called
    # Counter `i` starts at `num_tracked_procs` and flag `was_any_called` starts at 0
    push.0
    # => [was_any_called, i, pad(16)]

    # Loop through tracked procedures
    dup.1 neq.0
    while.true
        # => [was_any_called, i, pad(16)]

        # Get the tracked procedure root from storage
        dup.1 sub.1 push.TRACKED_PROCS_START_SLOT
        # => [TRACKED_PROCS_START_SLOT, i-1, was_any_called, i, pad(16)]

        exec.account::get_map_item
        # => [TRACKED_PROC_ROOT, was_any_called, i, pad(16)]

        exec.account::was_procedure_called
        # => [was_called, was_any_called, i, pad(16)]
        
        # Update was_any_called
        or
        # => [was_any_called', i, pad(16)]

        swap sub.1 swap
        # => [was_any_called', i-1, pad(16)]

        # Check if we should continue looping
        dup.1 neq.0
        # => [should_continue, was_any_called', i-1, pad(16)]
    end

    # => [was_any_called, i-1, pad(16)]

    # If any tracked procedure was called, perform signature verification
    if.true
        exec.::miden::contracts::auth::basic::auth__tx_rpo_falcon512
    end
    drop
end